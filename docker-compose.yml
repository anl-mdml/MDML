version: '3'

services:

    nginx:
        image: nginx
        restart: always
        environment:
            - NGINX_HOST=146.137.10.50
        ports:
            - 80:80
            - 443:443
        volumes:
            - ./nginx/nginx.conf:/etc/nginx/nginx.conf
            - /etc/pki/nginx:/etc/pki/nginx
            - /usr/share/nginx/html:/usr/share/nginx/html
        depends_on:
            - node_red

    mosquitto:
        # image: mosquitto_auth
        # restart: always
        # ports:
        #     - 1883:1883
        # environment:
        #     - MYSQL_ROOT_PASSWORD=je_MDML1228mosauth
        image: mosquitto
        restart: always
        ports:
            - 1883:1883
        volumes:
            - ./mosquitto/wordpass_file:/etc/mosquitto/wordpassfile
            - ./mosquitto/acl_file:/etc/mosquitto/acl_file
            - ./mosquitto/mosquitto.conf:/etc/mosquitto/mosquitto.conf
            - ./mosquitto/mosquitto.log:/var/log/mosquitto/mosquitto.log

    node_red:
        image: node_red
        user: root
        restart: always
        ports:
            - 1880:1880
        volumes:
            - ./node_red/data:/data
            - ./mdml_register/.s3cfg:/root/.s3cfg
        depends_on:
            - influxdb
            - mosquitto

    influxdb:
        image: influxdb
        restart: always
        ports:
            - 8086:8086
        environment:
            - INFLUXDB_DB=merf
            - INFLUXDB_HTTP_AUTH_ENABLED=true
            - INFLUXDB_ADMIN_USER=admin
            - INFLUXDB_ADMIN_PASSWORD=je_MDML1228influxdb
        volumes:
            - ./influxdb/lib:/var/lib/influxdb

    grafana:
        image: grafana
        restart: always
        ports:
            - 3000:3000
        environment:
            - GF_SECURITY_ADMIN_PASSWORD=je_MDML1228graf
        volumes:
            - ./grafana/grafana.ini:/etc/grafana/grafana.ini
            - /etc/pki/nginx:/etc/pki/nginx
            - ./grafana/data:/var/lib/grafana
        depends_on:
            - grafana_db
            - influxdb

    minio:
        image: minio
        restart: always
        ports:
            - 9000:9000
        environment:
            - MINIO_ACCESS_KEY=admin
            - MINIO_SECRET_KEY=je_MDML1228minio
        volumes:
            - ./minio/mnt/data:/data

    grafana_db:
        image: grafana_mysqldb
        command: --default-authentication-plugin=mysql_native_password
        restart: always
        ports:
            - 3306:3306
        environment: 
            - MYSQL_ROOT_PASSWORD=je_MDML1228gm
        volumes:
            - /var/lib/mysql:/var/lib/mysql

    register_account:
        image: register_account
        command: go run /root/register_mdml_user.go
        restart: always
        ports:
            - 8184:8184
        volumes:
            - ./mdml_register/MinIO_policies:/root/MinIO_policies
            - ./mdml_register/register_mdml_user.go:/root/register_mdml_user.go
            - ./mdml_register/add_mqtt_acl.sh:/root/add_mqtt_acl.sh
            - ./mdml_register/create_minio_bucket.py:/root/create_minio_bucket.py
            - ./mdml_register/config.json:/root/.mc/config.json
            - /etc/pki/nginx:/etc/pki/nginx
            - ./mosquitto/wordpassfile:/etc/mosquitto/wordpassfile
            - ./mosquitto/acl_file:/etc/mosquitto/acl_file
            - ./mosquitto/mosquitto.conf:/etc/mosquitto/mosquitto.conf
        depends_on:
            - nginx